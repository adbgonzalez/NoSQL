# Dataset e práctica de Query DSL para OpenSearch

Este material inclúe:

1. Un **dataset de proba** listo para cargar en **Dev Tools** (mapeo + `_bulk`).
2. Un conxunto de **exercicios de Query DSL** (enunciado + solución).
3. Un **script xerador en Python** para xerar 100–5000 documentos e un ficheiro `NDJSON` para `_bulk`.

---

## 1) Dataset de proba listo para Dev Tools

### 1.1 Crear índice cun mapeo “realista”

Pega en **OpenSearch Dashboards → Dev Tools → Console**:

```http
DELETE eventos

PUT eventos
{
  "mappings": {
    "properties": {
      "timestamp":   { "type": "date" },
      "mensaxe":     { "type": "tex# Dataset e práctica de Query DSL para OpenSearch

Este material inclúe:

1. Un **dataset de proba** listo para cargar en **Dev Tools** (mapeo + `_bulk`).
2. Un conxunto de **exercicios de Query DSL** (enunciado + solución).
3. Un **script xerador en Python** para xerar 100–5000 documentos e un ficheiro `NDJSON` para `_bulk`.

---

## 1) Dataset de proba listo para Dev Tools

### 1.1 Crear índice cun mapeo “realista”

Pega en **OpenSearch Dashboards → Dev Tools → Console**:

```http
DELETE eventos

PUT eventos
{
  "mappings": {
    "properties": {
      "timestamp":   { "type": "date" },
      "mensaxe":     { "type": "text" },
      "servizo":     { "type": "keyword" },
      "nivel":       { "type": "keyword" },
      "usuario":     { "type": "keyword" },
      "ip":          { "type": "ip" },
      "endpoint":    { "type": "keyword" },
      "status":      { "type": "integer" },
      "latency_ms":  { "type": "integer" },
      "request_id":  { "type": "keyword" }
    }
  }
}
```

---

### 1.2 Inserción masiva con `_bulk` (60 documentos)

> Nota: `_bulk` require liñas alternas **acción → documento**. Pega isto tal cal.

```http
POST _bulk
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:00:00","servizo":"auth","nivel":"info","usuario":"ana","ip":"192.168.1.10","endpoint":"/login","status":200,"latency_ms":42,"request_id":"r-0001","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:01:00","servizo":"auth","nivel":"warn","usuario":"ana","ip":"192.168.1.11","endpoint":"/login","status":401,"latency_ms":55,"request_id":"r-0002","mensaxe":"login fallido: credenciais incorrectas" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:02:00","servizo":"api","nivel":"info","usuario":"pepe","ip":"10.0.0.5","endpoint":"/v1/items","status":200,"latency_ms":63,"request_id":"r-0003","mensaxe":"consulta de items correcta" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:03:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":900,"request_id":"r-0004","mensaxe":"timeout na lectura da base de datos" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:04:00","servizo":"payments","nivel":"info","usuario":"laura","ip":"172.16.0.2","endpoint":"/pay","status":201,"latency_ms":120,"request_id":"r-0005","mensaxe":"pago procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:05:00","servizo":"api","nivel":"warn","usuario":"martin","ip":"10.0.0.6","endpoint":"/v1/items","status":429,"latency_ms":20,"request_id":"r-0006","mensaxe":"rate limit excedido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:06:00","servizo":"auth","nivel":"info","usuario":"noa","ip":"192.168.1.12","endpoint":"/token","status":200,"latency_ms":35,"request_id":"r-0007","mensaxe":"token emitido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:07:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":650,"request_id":"r-0008","mensaxe":"latencia alta en escritura" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:08:00","servizo":"payments","nivel":"error","usuario":"laura","ip":"172.16.0.2","endpoint":"/pay","status":502,"latency_ms":780,"request_id":"r-0009","mensaxe":"fallo do provedor de pagamento" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:09:00","servizo":"api","nivel":"info","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/orders","status":200,"latency_ms":88,"request_id":"r-0010","mensaxe":"listado de pedidos" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:00:00","servizo":"auth","nivel":"info","usuario":"pepe","ip":"192.168.1.13","endpoint":"/login","status":200,"latency_ms":48,"request_id":"r-0011","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:01:00","servizo":"auth","nivel":"warn","usuario":"pepe","ip":"192.168.1.14","endpoint":"/login","status":401,"latency_ms":52,"request_id":"r-0012","mensaxe":"login fallido: password incorrecto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:02:00","servizo":"api","nivel":"info","usuario":"noa","ip":"10.0.0.8","endpoint":"/v1/items","status":200,"latency_ms":71,"request_id":"r-0013","mensaxe":"consulta items ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:03:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":1100,"request_id":"r-0014","mensaxe":"deadlock detectado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:04:00","servizo":"payments","nivel":"warn","usuario":"martin","ip":"172.16.0.3","endpoint":"/refund","status":409,"latency_ms":210,"request_id":"r-0015","mensaxe":"reembolso duplicado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:05:00","servizo":"api","nivel":"info","usuario":"laura","ip":"10.0.0.9","endpoint":"/v1/orders","status":200,"latency_ms":95,"request_id":"r-0016","mensaxe":"consulta pedidos ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:06:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/token","status":500,"latency_ms":600,"request_id":"r-0017","mensaxe":"erro ao asinar token" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:07:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":720,"request_id":"r-0018","mensaxe":"cola de escritura saturada" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:08:00","servizo":"payments","nivel":"info","usuario":"ana","ip":"172.16.0.4","endpoint":"/pay","status":201,"latency_ms":140,"request_id":"r-0019","mensaxe":"pago procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:09:00","servizo":"api","nivel":"warn","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":404,"latency_ms":30,"request_id":"r-0020","mensaxe":"recurso non atopado" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:00:00","servizo":"auth","nivel":"info","usuario":"laura","ip":"192.168.1.15","endpoint":"/login","status":200,"latency_ms":44,"request_id":"r-0021","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:01:00","servizo":"api","nivel":"info","usuario":"martin","ip":"10.0.0.6","endpoint":"/v1/items","status":200,"latency_ms":67,"request_id":"r-0022","mensaxe":"consulta items correcta" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:02:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":980,"request_id":"r-0023","mensaxe":"timeout conexión DB" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:03:00","servizo":"payments","nivel":"error","usuario":"pepe","ip":"172.16.0.5","endpoint":"/pay","status":502,"latency_ms":850,"request_id":"r-0024","mensaxe":"gateway error no pagamento" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:04:00","servizo":"api","nivel":"warn","usuario":"noa","ip":"10.0.0.8","endpoint":"/v1/orders","status":429,"latency_ms":22,"request_id":"r-0025","mensaxe":"rate limit excedido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:05:00","servizo":"auth","nivel":"warn","usuario":"noa","ip":"192.168.1.12","endpoint":"/token","status":403,"latency_ms":40,"request_id":"r-0026","mensaxe":"token denegado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:06:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":690,"request_id":"r-0027","mensaxe":"latencia alta en commit" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:07:00","servizo":"payments","nivel":"info","usuario":"martin","ip":"172.16.0.3","endpoint":"/refund","status":200,"latency_ms":160,"request_id":"r-0028","mensaxe":"reembolso procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:08:00","servizo":"api","nivel":"info","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":200,"latency_ms":75,"request_id":"r-0029","mensaxe":"consulta items ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:09:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/login","status":500,"latency_ms":520,"request_id":"r-0030","mensaxe":"erro interno en autenticación" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:00:00","servizo":"api","nivel":"info","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":200,"latency_ms":66,"request_id":"r-0031","mensaxe":"consulta items ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:01:00","servizo":"api","nivel":"warn","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":404,"latency_ms":28,"request_id":"r-0032","mensaxe":"recurso non atopado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:02:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":1050,"request_id":"r-0033","mensaxe":"erro de conexión DB" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:03:00","servizo":"payments","nivel":"info","usuario":"laura","ip":"172.16.0.2","endpoint":"/pay","status":201,"latency_ms":135,"request_id":"r-0034","mensaxe":"pago procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:04:00","servizo":"auth","nivel":"warn","usuario":"pepe","ip":"192.168.1.14","endpoint":"/login","status":401,"latency_ms":58,"request_id":"r-0035","mensaxe":"login fallido: credenciais incorrectas" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:05:00","servizo":"auth","nivel":"info","usuario":"pepe","ip":"192.168.1.13","endpoint":"/login","status":200,"latency_ms":46,"request_id":"r-0036","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:06:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":740,"request_id":"r-0037","mensaxe":"cola de escritura saturada" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:07:00","servizo":"payments","nivel":"error","usuario":"martin","ip":"172.16.0.3","endpoint":"/refund","status":502,"latency_ms":820,"request_id":"r-0038","mensaxe":"gateway error no reembolso" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:08:00","servizo":"api","nivel":"warn","usuario":"noa","ip":"10.0.0.8","endpoint":"/v1/orders","status":429,"latency_ms":25,"request_id":"r-0039","mensaxe":"rate limit excedido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:09:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/token","status":500,"latency_ms":610,"request_id":"r-0040","mensaxe":"erro ao asinar token" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:00:00","servizo":"api","nivel":"info","usuario":"laura","ip":"10.0.0.9","endpoint":"/v1/orders","status":200,"latency_ms":92,"request_id":"r-0041","mensaxe":"listado de pedidos" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:01:00","servizo":"api","nivel":"info","usuario":"martin","ip":"10.0.0.6","endpoint":"/v1/items","status":200,"latency_ms":70,"request_id":"r-0042","mensaxe":"consulta items correcta" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:02:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":990,"request_id":"r-0043","mensaxe":"deadlock detectado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:03:00","servizo":"payments","nivel":"warn","usuario":"ana","ip":"172.16.0.4","endpoint":"/pay","status":409,"latency_ms":230,"request_id":"r-0044","mensaxe":"pago duplicado detectado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:04:00","servizo":"auth","nivel":"info","usuario":"noa","ip":"192.168.1.12","endpoint":"/token","status":200,"latency_ms":34,"request_id":"r-0045","mensaxe":"token emitido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:05:00","servizo":"auth","nivel":"warn","usuario":"noa","ip":"192.168.1.12","endpoint":"/token","status":403,"latency_ms":38,"request_id":"r-0046","mensaxe":"token denegado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:06:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":710,"request_id":"r-0047","mensaxe":"latencia alta en commit" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:07:00","servizo":"payments","nivel":"info","usuario":"pepe","ip":"172.16.0.5","endpoint":"/pay","status":201,"latency_ms":150,"request_id":"r-0048","mensaxe":"pago procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:08:00","servizo":"api","nivel":"warn","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":429,"latency_ms":21,"request_id":"r-0049","mensaxe":"rate limit excedido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:09:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/login","status":500,"latency_ms":540,"request_id":"r-0050","mensaxe":"erro interno en autenticación" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:00:00","servizo":"api","nivel":"info","usuario":"noa","ip":"10.0.0.8","endpoint":"/v1/items","status":200,"latency_ms":64,"request_id":"r-0051","mensaxe":"consulta items ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:01:00","servizo":"api","nivel":"warn","usuario":"martin","ip":"10.0.0.6","endpoint":"/v1/orders","status":404,"latency_ms":29,"request_id":"r-0052","mensaxe":"recurso non atopado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:02:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":1020,"request_id":"r-0053","mensaxe":"timeout conexión DB" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:03:00","servizo":"payments","nivel":"error","usuario":"laura","ip":"172.16.0.2","endpoint":"/pay","status":502,"latency_ms":830,"request_id":"r-0054","mensaxe":"gateway error no pagamento" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:04:00","servizo":"auth","nivel":"info","usuario":"ana","ip":"192.168.1.10","endpoint":"/login","status":200,"latency_ms":41,"request_id":"r-0055","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:05:00","servizo":"auth","nivel":"warn","usuario":"ana","ip":"192.168.1.11","endpoint":"/login","status":401,"latency_ms":57,"request_id":"r-0056","mensaxe":"login fallido: password incorrecto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:06:00","servizo":"payments","nivel":"warn","usuario":"pepe","ip":"172.16.0.5","endpoint":"/refund","status":409,"latency_ms":205,"request_id":"r-0057","mensaxe":"reembolso duplicado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:07:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":735,"request_id":"r-0058","mensaxe":"cola de escritura saturada" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:08:00","servizo":"api","nivel":"info","usuario":"laura","ip":"10.0.0.9","endpoint":"/v1/orders","status":200,"latency_ms":90,"request_id":"r-0059","mensaxe":"consulta pedidos ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:09:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/token","status":500,"latency_ms":605,"request_id":"r-0060","mensaxe":"erro ao asinar token" }
```

Opcional (pero recomendable) para refrescar inmediatamente os resultados:

```http
POST eventos/_refresh
```

---

## 2) Exercicios de Query DSL 

> Recoméndase que o alumnado intente resolver primeiro o exercicio e só despois consulte a solución.

### Exercicio 1 — Devolve só eventos `error`

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "term": { "nivel": "error" }
  }
}
```

---

### Exercicio 2 — Erros do servizo `db` nun intervalo temporal

**Enunciado:** `servizo=db` e `nivel=error` entre `2025-01-11T00:00:00` e `2025-01-12T00:00:00`.

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "bool": {
      "filter": [
        { "term":  { "servizo": "db" } },
        { "term":  { "nivel": "error" } },
        { "range": { "timestamp": { "gte": "2025-01-11T00:00:00", "lt": "2025-01-12T00:00:00" } } }
      ]
    }
  }
}
```

---

### Exercicio 3 — Full-text: mensaxes que conteñan “timeout”

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "match": { "mensaxe": "timeout" }
  }
}
```

---
### Exercicio 4 — Latencia alta: `latency_ms > 700`

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "range": { "latency_ms": { "gt": 700 } }
  }
}
```

---

### Exercicio 5 — Solicitudes fallidas HTTP (status >= 400) do endpoint `/login`

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "bool": {
      "filter": [
        { "term":  { "endpoint": "/login" } },
        { "range": { "status": { "gte": 400 } } }
      ]
    }
  }
}
```

---

### Exercicio 6 — Páxina 2 de resultados ordenados por tempo desc (10 por páxina)

**Solución:**
```http
GET eventos/_search
{
  "from": 10,
  "size": 10,
  "sort": [
    { "timestamp": { "order": "desc" } }
  ],
  "query": { "match_all": {} }
}
```

### Exercicio 7 — “Top 5” de servizos con máis eventos

**Solución (agregación):**
```http
GET eventos/_search
{
  "size": 0,
  "aggs": {
    "por_servizo": {
      "terms": { "field": "servizo", "size": 5 }
    }
  }
}
```

---

### Exercicio 8 — Contar eventos por `nivel` (info/warn/error)

**Solución:**
```http
GET eventos/_search
{
  "size": 0,
  "aggs": {
    "por_nivel": {
      "terms": { "field": "nivel" }
    }
  }
}
```

---



## ANEXO: Script xerador (Python) para crear 100–5000 docs e un ficheiro bulk

Este script xera:
- `create-index.json` (mapeo)
- `events.bulk.ndjson` (para `_bulk`)

### 3.1 Código: `generate_opensearch_events.py`

```python
import argparse
import json
import random
from datetime import datetime, timedelta, timezone

SERVICES = ["auth", "api", "db", "payments"]
LEVELS = ["info", "warn", "error"]
USERS = ["ana", "pepe", "laura", "martin", "noa", "system"]
ENDPOINTS = {
    "auth": ["/login", "/token"],
    "api": ["/v1/items", "/v1/orders"],
    "db": ["db:read", "db:write"],
    "payments": ["/pay", "/refund"],
}
IPS = [
    "192.168.1.10","192.168.1.11","192.168.1.12","192.168.1.13",
    "10.0.0.5","10.0.0.6","10.0.0.7","10.0.0.8","10.0.0.9","10.0.0.10",
    "172.16.0.2","172.16.0.3","172.16.0.4","172.16.0.5"
]

MESSAGES = {
    "auth": {
        "info": ["login correcto", "token emitido"],
        "warn": ["login fallido: credenciais incorrectas", "token denegado"],
        "error": ["erro interno en autenticación", "erro ao asinar token"],
    },
    "api": {
        "info": ["consulta items ok", "listado de pedidos", "consulta pedidos ok"],
        "warn": ["rate limit excedido", "recurso non atopado"],
        "error": ["erro inesperado no endpoint", "servizo non dispoñible"],
    },
    "db": {
        "info": ["lectura correcta", "escritura correcta"],
        "warn": ["latencia alta en commit", "cola de escritura saturada"],
        "error": ["timeout conexión DB", "deadlock detectado", "erro de conexión DB"],
    },
    "payments": {
        "info": ["pago procesado", "reembolso procesado"],
        "warn": ["pago duplicado detectado", "reembolso duplicado"],
        "error": ["gateway error no pagamento", "fallo do provedor de pagamento", "gateway error no reembolso"],
    },
}

def make_doc(ts: datetime, request_id: str) -> dict:
    servizo = random.choice(SERVICES)

    # Distribución: máis info ca warn, máis warn ca error
    nivel = random.choices(LEVELS, weights=[0.65, 0.25, 0.10], k=1)[0]

    usuario = "system" if servizo in ("db",) and nivel != "info" else random.choice(USERS)
    endpoint = random.choice(ENDPOINTS[servizo])
    ip = random.choice(IPS)

    # status plausible
    if nivel == "info":
        status = random.choice([200, 200, 200, 201])
    elif nivel == "warn":
        status = random.choice([401, 403, 404, 409, 429])
    else:
        status = random.choice([500, 502, 503])

    # latencia plausible
    if servizo == "db" and nivel in ("warn", "error"):
        latency_ms = random.randint(600, 1300)
    elif servizo == "payments" and nivel in ("warn", "error"):
        latency_ms = random.randint(180, 1000)
    else:
        latency_ms = random.randint(15, 120)

    mensaxe = random.choice(MESSAGES[servizo][nivel])

    return {
        "timestamp": ts.replace(microsecond=0).isoformat().replace("+00:00", "Z"),
        "mensaxe": mensaxe,
        "servizo": servizo,
        "nivel": nivel,
        "usuario": usuario,
        "ip": ip,
        "endpoint": endpoint,
        "status": status,
        "latency_ms": latency_ms,
        "request_id": request_id,
    }

def write_index_mapping(path: str):
    mapping = {
        "mappings": {
            "properties": {
                "timestamp":   {"type": "date"},
                "mensaxe":     {"type": "text"},
                "servizo":     {"type": "keyword"},
                "nivel":       {"type": "keyword"},
                "usuario":     {"type": "keyword"},
                "ip":          {"type": "ip"},
                "endpoint":    {"type": "keyword"},
                "status":      {"type": "integer"},
                "latency_ms":  {"type": "integer"},
                "request_id":  {"type": "keyword"},
            }
        }
    }
    with open(path, "w", encoding="utf-8") as f:
        json.dump(mapping, f, ensure_ascii=False, indent=2)
    print(f"[ok] wrote mapping -> {path}")

def write_bulk(path: str, index_name: str, n: int, start: datetime, step_seconds: int):
    ts = start
    with open(path, "w", encoding="utf-8") as f:
        for i in range(1, n + 1):
            action = {"index": {"_index": index_name}}
            doc = make_doc(ts, request_id=f"r-{i:06d}")
            f.write(json.dumps(action, ensure_ascii=False) + "\n")
            f.write(json.dumps(doc, ensure_ascii=False) + "\n")
            ts += timedelta(seconds=step_seconds)
    print(f"[ok] wrote bulk ndjson -> {path} ({n} docs)")

def main():
    ap = argparse.ArgumentParser(description="Generate OpenSearch events dataset (bulk NDJSON).")
    ap.add_argument("--index", default="eventos", help="Index name (default: eventos)")
    ap.add_argument("--n", type=int, default=500, help="Number of documents (default: 500)")
    ap.add_argument("--start", default="2025-01-10T08:00:00Z", help="Start timestamp ISO (default: 2025-01-10T08:00:00Z)")
    ap.add_argument("--step", type=int, default=60, help="Seconds between events (default: 60)")
    ap.add_argument("--out-bulk", default="events.bulk.ndjson", help="Output bulk file (default: events.bulk.ndjson)")
    ap.add_argument("--out-mapping", default="create-index.json", help="Output mapping file (default: create-index.json)")
    args = ap.parse_args()

    start = datetime.fromisoformat(args.start.replace("Z", "+00:00")).astimezone(timezone.utc)

    write_index_mapping(args.out_mapping)
    write_bulk(args.out_bulk, args.index, args.n, start, args.step)

if __name__ == "__main__":
    main()
```

### 3.2 Uso do script

Xerar 500 docs (1 evento/minuto):

```bash
python generate_opensearch_events.py --n 500 --step 60
```

Xerar 2000 docs (1 evento cada 5 segundos):

```bash
python generate_opensearch_events.py --n 2000 --step 5
```

### 3.3 Como cargalo en OpenSearch

Carga masiva con `_bulk`:

```bash
curl -k -u admin:CONTRASINAL -H "Content-Type: application/x-ndjson" \
  -XPOST "https://localhost:9200/_bulk" \
  --data-binary "@events.bulk.ndjson"
```

> Nota para Windows: para cargas grandes con `curl`, adoita ser máis cómodo empregar **WSL** ou **CMD**. Para docencia, a carga mediante Dev Tools é suficiente cando se traballa con pequenos lotes.
t" },
      "servizo":     { "type": "keyword" },
      "nivel":       { "type": "keyword" },
      "usuario":     { "type": "keyword" },
      "ip":          { "type": "ip" },
      "endpoint":    { "type": "keyword" },
      "status":      { "type": "integer" },
      "latency_ms":  { "type": "integer" },
      "request_id":  { "type": "keyword" }
    }
  }
}
```

---

### 1.2 Inserción masiva con `_bulk` (60 documentos)

> Nota: `_bulk` require liñas alternas **acción → documento**. Pega isto tal cal.

```http
POST _bulk
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:00:00","servizo":"auth","nivel":"info","usuario":"ana","ip":"192.168.1.10","endpoint":"/login","status":200,"latency_ms":42,"request_id":"r-0001","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:01:00","servizo":"auth","nivel":"warn","usuario":"ana","ip":"192.168.1.11","endpoint":"/login","status":401,"latency_ms":55,"request_id":"r-0002","mensaxe":"login fallido: credenciais incorrectas" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:02:00","servizo":"api","nivel":"info","usuario":"pepe","ip":"10.0.0.5","endpoint":"/v1/items","status":200,"latency_ms":63,"request_id":"r-0003","mensaxe":"consulta de items correcta" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:03:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":900,"request_id":"r-0004","mensaxe":"timeout na lectura da base de datos" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:04:00","servizo":"payments","nivel":"info","usuario":"laura","ip":"172.16.0.2","endpoint":"/pay","status":201,"latency_ms":120,"request_id":"r-0005","mensaxe":"pago procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:05:00","servizo":"api","nivel":"warn","usuario":"martin","ip":"10.0.0.6","endpoint":"/v1/items","status":429,"latency_ms":20,"request_id":"r-0006","mensaxe":"rate limit excedido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:06:00","servizo":"auth","nivel":"info","usuario":"noa","ip":"192.168.1.12","endpoint":"/token","status":200,"latency_ms":35,"request_id":"r-0007","mensaxe":"token emitido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:07:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":650,"request_id":"r-0008","mensaxe":"latencia alta en escritura" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:08:00","servizo":"payments","nivel":"error","usuario":"laura","ip":"172.16.0.2","endpoint":"/pay","status":502,"latency_ms":780,"request_id":"r-0009","mensaxe":"fallo do provedor de pagamento" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T08:09:00","servizo":"api","nivel":"info","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/orders","status":200,"latency_ms":88,"request_id":"r-0010","mensaxe":"listado de pedidos" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:00:00","servizo":"auth","nivel":"info","usuario":"pepe","ip":"192.168.1.13","endpoint":"/login","status":200,"latency_ms":48,"request_id":"r-0011","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:01:00","servizo":"auth","nivel":"warn","usuario":"pepe","ip":"192.168.1.14","endpoint":"/login","status":401,"latency_ms":52,"request_id":"r-0012","mensaxe":"login fallido: password incorrecto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:02:00","servizo":"api","nivel":"info","usuario":"noa","ip":"10.0.0.8","endpoint":"/v1/items","status":200,"latency_ms":71,"request_id":"r-0013","mensaxe":"consulta items ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:03:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":1100,"request_id":"r-0014","mensaxe":"deadlock detectado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:04:00","servizo":"payments","nivel":"warn","usuario":"martin","ip":"172.16.0.3","endpoint":"/refund","status":409,"latency_ms":210,"request_id":"r-0015","mensaxe":"reembolso duplicado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:05:00","servizo":"api","nivel":"info","usuario":"laura","ip":"10.0.0.9","endpoint":"/v1/orders","status":200,"latency_ms":95,"request_id":"r-0016","mensaxe":"consulta pedidos ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:06:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/token","status":500,"latency_ms":600,"request_id":"r-0017","mensaxe":"erro ao asinar token" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:07:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":720,"request_id":"r-0018","mensaxe":"cola de escritura saturada" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:08:00","servizo":"payments","nivel":"info","usuario":"ana","ip":"172.16.0.4","endpoint":"/pay","status":201,"latency_ms":140,"request_id":"r-0019","mensaxe":"pago procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T09:09:00","servizo":"api","nivel":"warn","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":404,"latency_ms":30,"request_id":"r-0020","mensaxe":"recurso non atopado" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:00:00","servizo":"auth","nivel":"info","usuario":"laura","ip":"192.168.1.15","endpoint":"/login","status":200,"latency_ms":44,"request_id":"r-0021","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:01:00","servizo":"api","nivel":"info","usuario":"martin","ip":"10.0.0.6","endpoint":"/v1/items","status":200,"latency_ms":67,"request_id":"r-0022","mensaxe":"consulta items correcta" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:02:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":980,"request_id":"r-0023","mensaxe":"timeout conexión DB" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:03:00","servizo":"payments","nivel":"error","usuario":"pepe","ip":"172.16.0.5","endpoint":"/pay","status":502,"latency_ms":850,"request_id":"r-0024","mensaxe":"gateway error no pagamento" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:04:00","servizo":"api","nivel":"warn","usuario":"noa","ip":"10.0.0.8","endpoint":"/v1/orders","status":429,"latency_ms":22,"request_id":"r-0025","mensaxe":"rate limit excedido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:05:00","servizo":"auth","nivel":"warn","usuario":"noa","ip":"192.168.1.12","endpoint":"/token","status":403,"latency_ms":40,"request_id":"r-0026","mensaxe":"token denegado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:06:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":690,"request_id":"r-0027","mensaxe":"latencia alta en commit" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:07:00","servizo":"payments","nivel":"info","usuario":"martin","ip":"172.16.0.3","endpoint":"/refund","status":200,"latency_ms":160,"request_id":"r-0028","mensaxe":"reembolso procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:08:00","servizo":"api","nivel":"info","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":200,"latency_ms":75,"request_id":"r-0029","mensaxe":"consulta items ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-10T10:09:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/login","status":500,"latency_ms":520,"request_id":"r-0030","mensaxe":"erro interno en autenticación" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:00:00","servizo":"api","nivel":"info","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":200,"latency_ms":66,"request_id":"r-0031","mensaxe":"consulta items ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:01:00","servizo":"api","nivel":"warn","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":404,"latency_ms":28,"request_id":"r-0032","mensaxe":"recurso non atopado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:02:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":1050,"request_id":"r-0033","mensaxe":"erro de conexión DB" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:03:00","servizo":"payments","nivel":"info","usuario":"laura","ip":"172.16.0.2","endpoint":"/pay","status":201,"latency_ms":135,"request_id":"r-0034","mensaxe":"pago procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:04:00","servizo":"auth","nivel":"warn","usuario":"pepe","ip":"192.168.1.14","endpoint":"/login","status":401,"latency_ms":58,"request_id":"r-0035","mensaxe":"login fallido: credenciais incorrectas" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:05:00","servizo":"auth","nivel":"info","usuario":"pepe","ip":"192.168.1.13","endpoint":"/login","status":200,"latency_ms":46,"request_id":"r-0036","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:06:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":740,"request_id":"r-0037","mensaxe":"cola de escritura saturada" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:07:00","servizo":"payments","nivel":"error","usuario":"martin","ip":"172.16.0.3","endpoint":"/refund","status":502,"latency_ms":820,"request_id":"r-0038","mensaxe":"gateway error no reembolso" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:08:00","servizo":"api","nivel":"warn","usuario":"noa","ip":"10.0.0.8","endpoint":"/v1/orders","status":429,"latency_ms":25,"request_id":"r-0039","mensaxe":"rate limit excedido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T08:09:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/token","status":500,"latency_ms":610,"request_id":"r-0040","mensaxe":"erro ao asinar token" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:00:00","servizo":"api","nivel":"info","usuario":"laura","ip":"10.0.0.9","endpoint":"/v1/orders","status":200,"latency_ms":92,"request_id":"r-0041","mensaxe":"listado de pedidos" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:01:00","servizo":"api","nivel":"info","usuario":"martin","ip":"10.0.0.6","endpoint":"/v1/items","status":200,"latency_ms":70,"request_id":"r-0042","mensaxe":"consulta items correcta" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:02:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":990,"request_id":"r-0043","mensaxe":"deadlock detectado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:03:00","servizo":"payments","nivel":"warn","usuario":"ana","ip":"172.16.0.4","endpoint":"/pay","status":409,"latency_ms":230,"request_id":"r-0044","mensaxe":"pago duplicado detectado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:04:00","servizo":"auth","nivel":"info","usuario":"noa","ip":"192.168.1.12","endpoint":"/token","status":200,"latency_ms":34,"request_id":"r-0045","mensaxe":"token emitido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:05:00","servizo":"auth","nivel":"warn","usuario":"noa","ip":"192.168.1.12","endpoint":"/token","status":403,"latency_ms":38,"request_id":"r-0046","mensaxe":"token denegado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:06:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":710,"request_id":"r-0047","mensaxe":"latencia alta en commit" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:07:00","servizo":"payments","nivel":"info","usuario":"pepe","ip":"172.16.0.5","endpoint":"/pay","status":201,"latency_ms":150,"request_id":"r-0048","mensaxe":"pago procesado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:08:00","servizo":"api","nivel":"warn","usuario":"ana","ip":"10.0.0.7","endpoint":"/v1/items","status":429,"latency_ms":21,"request_id":"r-0049","mensaxe":"rate limit excedido" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T09:09:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/login","status":500,"latency_ms":540,"request_id":"r-0050","mensaxe":"erro interno en autenticación" }

{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:00:00","servizo":"api","nivel":"info","usuario":"noa","ip":"10.0.0.8","endpoint":"/v1/items","status":200,"latency_ms":64,"request_id":"r-0051","mensaxe":"consulta items ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:01:00","servizo":"api","nivel":"warn","usuario":"martin","ip":"10.0.0.6","endpoint":"/v1/orders","status":404,"latency_ms":29,"request_id":"r-0052","mensaxe":"recurso non atopado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:02:00","servizo":"db","nivel":"error","usuario":"system","ip":"10.0.0.10","endpoint":"db:read","status":500,"latency_ms":1020,"request_id":"r-0053","mensaxe":"timeout conexión DB" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:03:00","servizo":"payments","nivel":"error","usuario":"laura","ip":"172.16.0.2","endpoint":"/pay","status":502,"latency_ms":830,"request_id":"r-0054","mensaxe":"gateway error no pagamento" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:04:00","servizo":"auth","nivel":"info","usuario":"ana","ip":"192.168.1.10","endpoint":"/login","status":200,"latency_ms":41,"request_id":"r-0055","mensaxe":"login correcto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:05:00","servizo":"auth","nivel":"warn","usuario":"ana","ip":"192.168.1.11","endpoint":"/login","status":401,"latency_ms":57,"request_id":"r-0056","mensaxe":"login fallido: password incorrecto" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:06:00","servizo":"payments","nivel":"warn","usuario":"pepe","ip":"172.16.0.5","endpoint":"/refund","status":409,"latency_ms":205,"request_id":"r-0057","mensaxe":"reembolso duplicado" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:07:00","servizo":"db","nivel":"warn","usuario":"system","ip":"10.0.0.10","endpoint":"db:write","status":503,"latency_ms":735,"request_id":"r-0058","mensaxe":"cola de escritura saturada" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:08:00","servizo":"api","nivel":"info","usuario":"laura","ip":"10.0.0.9","endpoint":"/v1/orders","status":200,"latency_ms":90,"request_id":"r-0059","mensaxe":"consulta pedidos ok" }
{ "index": { "_index": "eventos" } }
{ "timestamp":"2025-01-11T10:09:00","servizo":"auth","nivel":"error","usuario":"system","ip":"192.168.1.1","endpoint":"/token","status":500,"latency_ms":605,"request_id":"r-0060","mensaxe":"erro ao asinar token" }
```

Opcional (pero recomendable) para refrescar inmediatamente os resultados:

```http
POST eventos/_refresh
```

---

## 2) Exercicios de Query DSL (enunciado + solución)

> Recoméndase que o alumnado intente resolver primeiro o exercicio e só despois consulte a solución.

### Exercicio 1 — Devolve só eventos `error`

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "term": { "nivel": "error" }
  }
}
```

---

### Exercicio 2 — Erros do servizo `db` nun intervalo temporal

**Enunciado:** `servizo=db` e `nivel=error` entre `2025-01-11T00:00:00` e `2025-01-12T00:00:00`.

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "bool": {
      "filter": [
        { "term":  { "servizo": "db" } },
        { "term":  { "nivel": "error" } },
        { "range": { "timestamp": { "gte": "2025-01-11T00:00:00", "lt": "2025-01-12T00:00:00" } } }
      ]
    }
  }
}
```

---

### Exercicio 3 — Full-text: mensaxes que conteñan “timeout”

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "match": { "mensaxe": "timeout" }
  }
}
```

---

### Exercicio 4 — “Top 5” de servizos con máis eventos

**Solución (agregación):**
```http
GET eventos/_search
{
  "size": 0,
  "aggs": {
    "por_servizo": {
      "terms": { "field": "servizo", "size": 5 }
    }
  }
}
```

---

### Exercicio 5 — Contar eventos por `nivel` (info/warn/error)

**Solución:**
```http
GET eventos/_search
{
  "size": 0,
  "aggs": {
    "por_nivel": {
      "terms": { "field": "nivel" }
    }
  }
}
```

---

### Exercicio 6 — Latencia alta: `latency_ms > 700`

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "range": { "latency_ms": { "gt": 700 } }
  }
}
```

---

### Exercicio 7 — Solicitudes fallidas HTTP (status >= 400) do endpoint `/login`

**Solución:**
```http
GET eventos/_search
{
  "query": {
    "bool": {
      "filter": [
        { "term":  { "endpoint": "/login" } },
        { "range": { "status": { "gte": 400 } } }
      ]
    }
  }
}
```

---

### Exercicio 8 — Páxina 2 de resultados ordenados por tempo desc (10 por páxina)

**Solución:**
```http
GET eventos/_search
{
  "from": 10,
  "size": 10,
  "sort": [
    { "timestamp": { "order": "desc" } }
  ],
  "query": { "match_all": {} }
}
```

---

## 3) Script xerador (Python) para crear 100–5000 docs e un ficheiro bulk

Este script xera:
- `create-index.json` (mapeo)
- `events.bulk.ndjson` (para `_bulk`)

### 3.1 Código: `generate_opensearch_events.py`

```python
import argparse
import json
import random
from datetime import datetime, timedelta, timezone

SERVICES = ["auth", "api", "db", "payments"]
LEVELS = ["info", "warn", "error"]
USERS = ["ana", "pepe", "laura", "martin", "noa", "system"]
ENDPOINTS = {
    "auth": ["/login", "/token"],
    "api": ["/v1/items", "/v1/orders"],
    "db": ["db:read", "db:write"],
    "payments": ["/pay", "/refund"],
}
IPS = [
    "192.168.1.10","192.168.1.11","192.168.1.12","192.168.1.13",
    "10.0.0.5","10.0.0.6","10.0.0.7","10.0.0.8","10.0.0.9","10.0.0.10",
    "172.16.0.2","172.16.0.3","172.16.0.4","172.16.0.5"
]

MESSAGES = {
    "auth": {
        "info": ["login correcto", "token emitido"],
        "warn": ["login fallido: credenciais incorrectas", "token denegado"],
        "error": ["erro interno en autenticación", "erro ao asinar token"],
    },
    "api": {
        "info": ["consulta items ok", "listado de pedidos", "consulta pedidos ok"],
        "warn": ["rate limit excedido", "recurso non atopado"],
        "error": ["erro inesperado no endpoint", "servizo non dispoñible"],
    },
    "db": {
        "info": ["lectura correcta", "escritura correcta"],
        "warn": ["latencia alta en commit", "cola de escritura saturada"],
        "error": ["timeout conexión DB", "deadlock detectado", "erro de conexión DB"],
    },
    "payments": {
        "info": ["pago procesado", "reembolso procesado"],
        "warn": ["pago duplicado detectado", "reembolso duplicado"],
        "error": ["gateway error no pagamento", "fallo do provedor de pagamento", "gateway error no reembolso"],
    },
}

def make_doc(ts: datetime, request_id: str) -> dict:
    servizo = random.choice(SERVICES)

    # Distribución: máis info ca warn, máis warn ca error
    nivel = random.choices(LEVELS, weights=[0.65, 0.25, 0.10], k=1)[0]

    usuario = "system" if servizo in ("db",) and nivel != "info" else random.choice(USERS)
    endpoint = random.choice(ENDPOINTS[servizo])
    ip = random.choice(IPS)

    # status plausible
    if nivel == "info":
        status = random.choice([200, 200, 200, 201])
    elif nivel == "warn":
        status = random.choice([401, 403, 404, 409, 429])
    else:
        status = random.choice([500, 502, 503])

    # latencia plausible
    if servizo == "db" and nivel in ("warn", "error"):
        latency_ms = random.randint(600, 1300)
    elif servizo == "payments" and nivel in ("warn", "error"):
        latency_ms = random.randint(180, 1000)
    else:
        latency_ms = random.randint(15, 120)

    mensaxe = random.choice(MESSAGES[servizo][nivel])

    return {
        "timestamp": ts.replace(microsecond=0).isoformat().replace("+00:00", "Z"),
        "mensaxe": mensaxe,
        "servizo": servizo,
        "nivel": nivel,
        "usuario": usuario,
        "ip": ip,
        "endpoint": endpoint,
        "status": status,
        "latency_ms": latency_ms,
        "request_id": request_id,
    }

def write_index_mapping(path: str):
    mapping = {
        "mappings": {
            "properties": {
                "timestamp":   {"type": "date"},
                "mensaxe":     {"type": "text"},
                "servizo":     {"type": "keyword"},
                "nivel":       {"type": "keyword"},
                "usuario":     {"type": "keyword"},
                "ip":          {"type": "ip"},
                "endpoint":    {"type": "keyword"},
                "status":      {"type": "integer"},
                "latency_ms":  {"type": "integer"},
                "request_id":  {"type": "keyword"},
            }
        }
    }
    with open(path, "w", encoding="utf-8") as f:
        json.dump(mapping, f, ensure_ascii=False, indent=2)
    print(f"[ok] wrote mapping -> {path}")

def write_bulk(path: str, index_name: str, n: int, start: datetime, step_seconds: int):
    ts = start
    with open(path, "w", encoding="utf-8") as f:
        for i in range(1, n + 1):
            action = {"index": {"_index": index_name}}
            doc = make_doc(ts, request_id=f"r-{i:06d}")
            f.write(json.dumps(action, ensure_ascii=False) + "\n")
            f.write(json.dumps(doc, ensure_ascii=False) + "\n")
            ts += timedelta(seconds=step_seconds)
    print(f"[ok] wrote bulk ndjson -> {path} ({n} docs)")

def main():
    ap = argparse.ArgumentParser(description="Generate OpenSearch events dataset (bulk NDJSON).")
    ap.add_argument("--index", default="eventos", help="Index name (default: eventos)")
    ap.add_argument("--n", type=int, default=500, help="Number of documents (default: 500)")
    ap.add_argument("--start", default="2025-01-10T08:00:00Z", help="Start timestamp ISO (default: 2025-01-10T08:00:00Z)")
    ap.add_argument("--step", type=int, default=60, help="Seconds between events (default: 60)")
    ap.add_argument("--out-bulk", default="events.bulk.ndjson", help="Output bulk file (default: events.bulk.ndjson)")
    ap.add_argument("--out-mapping", default="create-index.json", help="Output mapping file (default: create-index.json)")
    args = ap.parse_args()

    start = datetime.fromisoformat(args.start.replace("Z", "+00:00")).astimezone(timezone.utc)

    write_index_mapping(args.out_mapping)
    write_bulk(args.out_bulk, args.index, args.n, start, args.step)

if __name__ == "__main__":
    main()
```

### 3.2 Uso do script

Xerar 500 docs (1 evento/minuto):

```bash
python generate_opensearch_events.py --n 500 --step 60
```

Xerar 2000 docs (1 evento cada 5 segundos):

```bash
python generate_opensearch_events.py --n 2000 --step 5
```

### 3.3 Como cargalo en OpenSearch

Carga masiva con `_bulk`:

```bash
curl -k -u admin:CONTRASINAL -H "Content-Type: application/x-ndjson" \
  -XPOST "https://localhost:9200/_bulk" \
  --data-binary "@events.bulk.ndjson"
```

> Nota para Windows: para cargas grandes con `curl`, adoita ser máis cómodo empregar **WSL** ou **CMD**. Para docencia, a carga mediante Dev Tools é suficiente cando se traballa con pequenos lotes.
