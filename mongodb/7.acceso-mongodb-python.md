# Acceso a MongoDB desde Python

Para conectarnos a MongoDB desde Python empregaremos a libraría oficial **pymongo**, que proporciona unha API completa para realizar conexións, inserir documentos, consultar coleccións, realizar actualizacións, agregacións e traballar con índices.

---

## 1. Instalación da libraría

Para instalar *pymongo*, utilizamos:

```bash
pip install pymongo
```

Se traballas con JupyterLab ou notebooks, tamén funciona:

```python
!pip install pymongo
```

---

## 2. Conexión a MongoDB

### 2.1. Conexión a un servidor local

```python
from pymongo import MongoClient

cliente = MongoClient("mongodb://localhost:27017/")
bd = cliente["mibd"]
coleccion = bd["gente"]
```

### 2.2. Conexión a MongoDB Atlas

A cadea depende do teu clúster. O modelo xeral é:

```python
from pymongo import MongoClient

cadea_conexion = "mongodb+srv://usuario:contrasinal@cluster.mongodb.net/"
cliente = MongoClient(cadea_conexion)

bd = cliente["sample_mflix"]
coleccion = bd["movies"]
```

---

## 3. Inserir documentos

### 3.1. Inserir un único documento

```python
documento = {
    "nome": "Adrián Blanco",
    "idade": 39,
    "profesion": "profesor"
}

resultado = coleccion.insert_one(documento)
print(resultado.inserted_id)
```

### 3.2. Inserir varios documentos

```python
docs = [
    {"nome": "Ana", "idade": 20},
    {"nome": "Xosé", "idade": 25}
]

resultado = coleccion.insert_many(docs)
print(resultado.inserted_ids)
```

---

## 4. Consultar documentos

### 4.1. Obter un documento

```python
doc = coleccion.find_one()
print(doc)
```

### 4.2. Obter varios documentos

```python
for doc in coleccion.find():
    print(doc)
```

### 4.3. Consulta con filtro

```python
for doc in coleccion.find({"idade": {"$gt": 30}}):
    print(doc)
```

### 4.4. Consulta con proxección

```python
for doc in coleccion.find({}, {"_id": 0, "nome": 1}):
    print(doc)
```

---

## 5. Actualización de documentos

### 5.1. Actualizar un documento

```python
coleccion.update_one(
    {"nome": "Ana"},
    {"$set": {"idade": 21}}
)
```

### 5.2. Actualizar varios documentos

```python
coleccion.update_many(
    {"idade": {"$lt": 30}},
    {"$inc": {"idade": 1}}
)
```

---

## 6. Eliminar documentos

### 6.1. Eliminar un documento

```python
coleccion.delete_one({"nome": "Xosé"})
```

### 6.2. Eliminar varios documentos

```python
coleccion.delete_many({"idade": {"$gt": 50}})
```

---

## 7. Uso de Aggregation Pipeline en Python

O método é exactamente igual ao shell, pero pasando unha lista de dicionarios:

```python
pipeline = [
    {"$match": {"genres": "Drama"}},
    {"$group": {"_id": "$year", "total": {"$sum": 1}}},
    {"$sort": {"total": -1}}
]

for doc in bd["movies"].aggregate(pipeline):
    print(doc)
```

---

## 8. Crear índices

```python
coleccion.create_index("nome")
coleccion.create_index([("idade", -1)])
```

---

## 9. Manexo de erros

Pódense capturar excepcións útiles de pymongo:

```python
from pymongo.errors import ConnectionFailure

try:
    cliente.admin.command("ping")
    print("Conexión correcta")
except ConnectionFailure:
    print("Erro conectando a MongoDB")
```

---

## 10. Pechar a conexión

A conexión péchase automaticamente cando o obxecto é destruído, pero tamén se pode facer manualmente:

```python
cliente.close()
```
