# Guía de Query DSL en OpenSearch

Guía pensada para consultar en caso de dúbida ao facer os laboratorios. Inclúe o mínimo imprescindible para completar a práctica do índice `eventos`, sen introducir conceptos que non aparezan no laboratorio.

---

## 0. Contexto: que é o que se está a facer

En OpenSearch:

- Un **índice** é un contedor de documentos JSON.
- Cada documento ten **campos** (timestamp, nivel, usuario…).
- Query DSL é unha linguaxe en JSON para:
  - Buscar documentos
  - Filtrar condicións
  - Ordenar e paginar resultados
  - Realizar cálculos e agrupacións (agregacións)

---

## 1. Estrutura básica dunha consulta

A estrutura máis habitual é:

    GET indice/_search
    {
      "query": { ... }
    }

Elementos que poden aparecer no corpo:

- `query` → condicións de busca
- `size` → número de documentos devoltos
- `from` → desprazamento (paxinación)
- `sort` → ordenación
- `aggs` → agregacións (resumos estatísticos)

---

## 2. Consultas básicas para comprobar datos

### 2.1 Ver documentos: `match_all`

Devolve documentos sen aplicar filtros.

    GET eventos/_search
    {
      "query": { "match_all": {} }
    }

Por defecto devolve 10 documentos.

---

### 2.2 Contar documentos: `_count`

Conta todos os documentos dun índice:

    GET eventos/_count

Contar con condición:

    GET eventos/_count
    {
      "query": {
        "term": { "nivel": "error" }
      }
    }

---

## 3. Consultas exactas (term-level)

Non analizan o texto. Úsanse con campos `keyword`, numéricos ou datas.

### 3.1 `term`

Busca coincidencia exacta.

    GET eventos/_search
    {
      "query": {
        "term": { "nivel": "warn" }
      }
    }

Uso típico:
- nivel
- servizo
- usuario
- endpoint

---

## 4. Consultas full-text

Analizan o texto segundo o analizador do campo.

### 4.1 `match`

    GET eventos/_search
    {
      "query": {
        "match": { "mensaxe": "timeout" }
      }
    }

Uso típico:
- Campos `text`
- Buscas por palabras dentro de mensaxes

---

## 5. Consultas por rango

Filtran valores dentro dun intervalo.

    GET eventos/_search
    {
      "query": {
        "range": {
          "latency_ms": { "gt": 700 }
        }
      }
    }

Operadores habituais:

- `gt`  → maior que
- `gte` → maior ou igual
- `lt`  → menor que
- `lte` → menor ou igual

Tamén se usa con datas:

    GET eventos/_search
    {
      "query": {
        "range": {
          "timestamp": {
            "gte": "2025-01-11T00:00:00",
            "lt":  "2025-01-12T00:00:00"
          }
        }
      }
    }

---

## 6. Consultas compostas: `bool`

Permiten combinar condicións.

    GET eventos/_search
    {
      "query": {
        "bool": {
          "filter": [
            { "term":  { "servizo": "db" } },
            { "term":  { "nivel": "error" } }
          ]
        }
      }
    }

Cláusulas principais:

- `must` → condición obrigatoria (afecta relevancia)
- `filter` → condición obrigatoria (non calcula relevancia)
- `should` → condición opcional
- `must_not` → exclusión

Uso recomendado en logs:
- `filter` para termos exactos e rangos
- `must` para texto (`match`)

---

## 7. Ordenación e paxinación

### 7.1 Ordenar

    GET eventos/_search
    {
      "sort": [
        { "timestamp": { "order": "desc" } }
      ],
      "query": { "match_all": {} }
    }

---

### 7.2 Páxinas de resultados

    GET eventos/_search
    {
      "from": 10,
      "size": 10,
      "query": { "match_all": {} }
    }

- `size` → cantos documentos devolver
- `from` → desde que posición comezar

---

## 8. Agregacións (analítica)

As agregacións non devolven documentos individuais, senón resumos.

### 8.1 Estrutura xeral

    GET eventos/_search
    {
      "size": 0,
      "aggs": {
        "nome_agregacion": {
          "tipo": { ... }
        }
      }
    }

`size: 0` indica que non se queren documentos, só resultados agregados.

---

### 8.2 Agregación por termos (`terms`)

Top 5 servizos con máis eventos:

    GET eventos/_search
    {
      "size": 0,
      "aggs": {
        "por_servizo": {
          "terms": {
            "field": "servizo",
            "size": 5
          }
        }
      }
    }

Isto devolve:

- `buckets`
  - `key` → valor do campo
  - `doc_count` → número de documentos

---

### 8.3 Contar por nivel

    GET eventos/_search
    {
      "size": 0,
      "aggs": {
        "por_nivel": {
          "terms": { "field": "nivel" }
        }
      }
    }

---

## 9. Estrutura das respostas

Resposta típica:

    {
      "took": 5,
      "timed_out": false,
      "hits": {
        "total": { "value": 60 },
        "hits": [
          {
            "_index": "eventos",
            "_id": "abc123",
            "_score": 1.23,
            "_source": { ... }
          }
        ]
      }
    }

Campos importantes:

- `took` → tempo en ms
- `hits.total.value` → número total de documentos que cumpren a consulta
- `hits.hits` → documentos devoltos
- `_source` → contido real do documento

---

## 10. Resumo final

Query DSL permite:

- Buscar documentos
- Filtrar condicións exactas e por rango
- Combinar condicións con `bool`
- Ordenar e paginar resultados
- Realizar agregacións para análise

Todo o que se emprega no laboratorio está cuberto nesta guía.
