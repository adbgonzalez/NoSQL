# Primeiros pasos con MongoDB

## Operacións básicas:

 1. Mostrar bases de datos
```javascript
show dbs
```

 2. Crear ou usar unha base de datos existente
```javascript
use mibd
```

 3. Mostrar coleccións da base de datos actual
```javascript
show collections
```

 4. Inserir un documento nunha nova colección
```javascript
db.gente.insertOne({
  nombre: "Adrián Blanco",
  idade: 39,
  profesión: "profesor"
});
```

 5. Recuperar documentos

   - Recuperar un documento
```javascript
db.gente.findOne()
```

  - Recuperar toda a colección
```javascript
db.gente.find()
```
## Tipos de datos en MongoDB
MongoDB emprega o formato **BSON**, unha extensión binaria de **JSON** que permite almacenar máis tipos de datos que JSON estándar. Cada campo dun documento ten un tipo asociado, e é importante coñecelos para realizar consultas correctas e evitar problemas de validación ou comparación.

A seguinte táboa recolle os tipos máis utilizados:

| Tipo BSON         | Descrición                               | Exemplo                           |
| ----------------- | ---------------------------------------- | --------------------------------- |
| **String**        | Cadea de texto                           | `"texto"`                         |
| **Int32 / Int64** | Enteros de 32 ou 64 bits                 | `42`, `1234567890123`             |
| **Double**        | Número decimal                           | `3.14`                            |
| **Boolean**       | Valor lóxico                             | `true`, `false`                   |
| **Date**          | Data e hora (en milisegundos desde 1970) | `ISODate("2024-01-01T00:00:00Z")` |
| **Object**        | Documento embebido                       | `{ nome: "Ana", idade: 20 }`      |
| **Array**         | Lista de valores                         | `[1, 2, 3]`                       |
| **ObjectId**      | Identificador único de MongoDB           | `ObjectId("65afc1d9d2...")`       |
| **Null**          | Valor nulo                               | `null`                            |
| **Regex**         | Expresión regular                        | `/abc/`                           |
| **Binary Data**   | Datos binarios                           | `<BinData>`                       |
| **Timestamp**     | Marca de tempo especial de MongoDB       | `Timestamp(12345, 1)`             |
| **Decimal128**    | Decimal de alta precisión                | `NumberDecimal("23.456")`         |

## Consultas en MongoDB

- Consultas simples: Devolver os documentos que cumpran un determinado criterio.
```javascript
db.coleccion.find({ campo: valor })
```

### Operadores lóxicos 
Podemos establecer varios criterios e combinalos empregando os operadores lóxicos:
| Operador | Significado |
|----------|-------------------|
| $and | AND |
| $or | OR |
| $not | Negación |
| $nor | NOR |


- Consultas con varios criterios (AND implícito)
```javascript
db.coleccion.find({ campo1: valor1, campo2: valor2 })
```

  - Alternativa con $and
```javascript
db.coleccion.find({
  $and: [
    { campo1: valor1 },
    { campo2: valor2 }
  ]
})
```
Neste caso é preferible indicar primeiro os criterios que van devolver un menor número de documentos.
![Consulta and 1](images/mongo-consulta-and-1.png)
![Consulta and 2](images/mongo-consulta-and-2.png)
- Consultas con operador `OR`.
```javascript
db.coleccion.find({
  $or: [
    { campo1: valor1 },
    { campo2: valor2 }
  ]
})
```
Neste caso, por motivos de rendemento, é recomendable filtrar primeiro os criterios máis grandes, para reducir o número de documentos que se van comprobar para os criterios restantes.
![Consulta or 1](images/mongo-consulta-or-1.png)
![Consulta or 2](images/mongo-consulta-or-2.png)

- Consultas con operador `NOT`
```javascript
db.coleccion.find({
  campo: {
    $not: { $gt: valor }
  }
})

```

- Consultas con operador `NOR`.
```javascript
db.coleccion.find({
  $nor: [
    { campo1: valor1 },
    { campo2: valor2 }
  ]
})

```
### Operadores de comparación, de existencia e tipos

| Operador | Significado |
|----------|-----------|
| $lt | Menor que (<) |
| $lte | Menor ou igual que (<=) |
| $gt | Maior que (>) |
| $gte | Maior ou igual que (>=) |
| $eq | Igual a |
| $ne | Distinto de |
| $exists | Existe |
| $type | Comproba o tipo do campo |

#### Operadores de comparación

- Consultas con operador `$lt` (menor que).
```javascript
db.coleccion.find({
  campo: { $lt: valor }
})
```

- Consultas con operador `$lte` (menor ou igual que).
```javascript
db.coleccion.find({
  campo: { $lte: valor }
})
```

- Consultas con operador `$gt` (maior que).
```javascript
db.coleccion.find({
  campo: { $gt: valor }
})
```

- Consultas con operador `$gte` (maior ou igual que).
```javascript
db.coleccion.find({
  campo: { $gte: valor }
})
```

- Consultas con operador `$eq` (igual a).
```javascript
db.coleccion.find({
  campo: { $eq: valor }
})
```

- Consultas con operador `$ne` (distinto de).
```javascript
db.coleccion.find({
  campo: { $ne: valor }
})
```

#### Operadores de existencia e tipo

- Consultas con operador `$exists` (comprobar se un campo existe ou non).
```javascript
db.coleccion.find({
  campo: { $exists: true }
})
```

- Consultas con operador `$type` (comprobar o tipo dun campo).
```javascript
db.coleccion.find({
  campo: { $type: "string" }
})
```

### Operadores para arrays

| Operador   | Significado                                   |
| ---------- | --------------------------------------------- |
| $in        | O valor está nunha lista                      |
| $nin       | O valor NON está nunha lista                  |
| $all       | O array contén todos os valores indicados     |
| $size      | O array ten un tamaño específico              |
| $elemMatch | Un elemento do array cumpre varias condicións |

- Consultas con operador `$in` (o valor está nalgunha das opcións)
```javascript
db.coleccion.find({
  campo: { $in: ["valor1", "valor2"] }
})
```

- Consultas con operador `$nin` (o valor NON está na lista)
```javascript
db.coleccion.find({
  campo: { $nin: ["valor1", "valor2"] }
})
```

- Consultas con operador `$all` (o array contén todos os valores indicados)
```javascript
db.coleccion.find({
  campo: { $all: ["valor1", "valor2"] }
})
```

- Consultas con operador `$size` (o array ten un tamaño específico)
```javascript
db.coleccion.find({
  campo: { $size: 3 }
})
```

- Consultas con operador `$elemMatch` (un elemento do array cumpre varias condicións)
```javascript
db.coleccion.find({
  campo: {
    $elemMatch: {
      tipo: "exame",
      nota: { $gte: 8 }
    }
  }
})
```
## Expresións regulares
As expresións regulares permiten buscar coincidencias parciais ou patróns nun campo de texto. MongoDB utiliza o motor de regex de JavaScript.

- Coincidencia simple (contén a subcadea)
```javascript
db.coleccion.find({
  campo1: /subcadea/
})
```

- Coincidencia ao comezo da cadea (^)
```javascript
db.coleccion.find({
  campo1: /^inicio/
})
```

- Coincidencia ao final da cadea ($)
```javascript
db.coleccion.find({
  campo1: /fin$/
})
```

- Coincidencia sen distinguir maiúsculas/minúsculas (i)
```javascript
db.coleccion.find({
  campo1: /texto/i
})
```

- Expresión regular complexa
```javascript
db.coleccion.find({
  campo1: /^[A-Z]{3}[0-9]{2}$/
})
```

- Uso explícito con $regex e $options
```javascript
db.coleccion.find({
  campo1: { $regex: "subcadea", $options: "i" }
})
```

- Alternancia (opcións múltiples mediante |)
```javascript
db.coleccion.find({
  campo1: /(ourense|vigo|coruña)/i
})
```

## Proxección
MongoDB permite controlar que campos se devolven nos documentos dunha consulta. Isto é útil para:
- Reducir o tamaño da resposta.
- Ocultar campos que non interesan (por exemplo, `_id`).
- Mostrar só a información relevante dunha colección.
- Mellorar o rendemento en consultas con documentos moi grandes.

A **proxección** defínese no segundo parámetro do método `.find()`.
```javascript
db.coleccion.find(
  { campo1: "valor1" },
  { _id: 0, campo2: 1 }
)
```
Neste caso:
- O primeiro argumento `{ campo1: "valor1" }` é o filtro da consulta.
- O segundo argumento `{ _id: 0, campo2: 1 }` é a proxección.
- `campo2:1` indica que queremos amosar ese campo.
- `_id: 0` indica que non quemos amosar o identificador (por defecto amósase, é o único campo que hai que ocultar explícitamente).

## Outras operacións e casos especiais
### Contar documentos
Podemos obter o número de documentos mediante a función `countDocuments`.
```javascript
db.coleccion.countDocuments({ campo1: 'valor1' })
db.coleccion.find({ campo1: 'valor1' }).count()
```


### Uso de $expr
O operador `$expr` permite empregar expresións de agregación dentro dunha consulta estándar. Permite, entre outras cousas:
- Comparar dous campos entre si.
- Utilizar operadores como `$gt`, `$eq`, `$add`, `$substract`, etc.
- Realizar condicións dinámicas que dependen dos valores internos do documento.

Exemplo: comparar dous campos:
```javascript
db.coleccion.find({
  $expr: { $eq: ["$campo1", "$campo2"] }
})
```
Exemplo: cálculo dentro da consulta
```javascript
db.coleccion.find({
  $expr: { $gt: ["$idade", { $add: [18, 2] }] }
})
```
### Consultas sobre obxectos anidados
Como xa se profundizará, un campo dun documento pode, a súa vez, ser outro documento. Para referirse a subcampos empregarase a seguinte sintaxe:

```javascript
db.coleccion.find({ "campo3.subcampo1": "valor-subcampo" })
```

### Consultas sobre arrays
Un campo dun documento pode ser un array. Neste caso os operadores de arrays vistos anteriormente son moi útiles.
```javascript
db.coleccion.find({ campo: { $all: ["valor1", "valor2"] } })
db.coleccion.find({ campo: { $in: ["valor1", "valor2"] } })
```



### Valores distintos
Para obter os valores distintos para un determinado campo dunha colección empregarase a función `distinct()`.
```javascript
db.coleccion.distinct("campo1")
db.coleccion.distinct("campo1", { campo2: "valor2" })
```

### Ordenar e limitar resultados
MongoDB permite ordenar e limitar os resultados dunha consulta usando os métodos `.sort()` e `.limit()`.
```javascript
db.coleccion.find({ campo1: valor1 })
  .sort({ campoA: 1 })
```
Neste caso ordenaríanse os resultados polo campo `campoA`.
O valor indica se a orde é ascendete ou descendente:
- 1: ascendente.
- -1: descendente.

Para limitar o número de resultados pódese usar a función `.limit()`. O parámetro indica o número de resultados a amosar.

```javascript
db.coleccion.find({ campo1: valor1 })
  .sort({ campoA: 1 })
  .limit(numero)
```

## Exemplos

### Consultas básicas

1. (BD: sample_training) Selecciona todos os documentos da colección zips cuxo estado (`state`) sexa 'AL'.
```javascript

db.zips.find({ state: "AL" })
```

2. (BD: sample_training) Selecciona un documento de zips onde o ZIP code sexa '35004'.
```javascript

db.zips.findOne({ zip: "35004" })
```

3. (BD: sample_training) Selecciona os documentos da colección zips cuxo estado ('AL') teña poboación superior a 5000.
```javascript
db.zips.find({ state: "AL", pop: { $gt: 5000 } })
```

### Operadores lóxicos

4. (BD: sample_training) Selecciona cidades do estado de California cunha poboación entre 10.000 e 20.000.
```javascript
db.zips.find({
  $and: [
    { state: "CA" },
    { pop: { $gte: 10000 } },
    { pop: { $lte: 20000 } }
  ]
})
```

5. (BD: sample_training) Selecciona documentos onde o estado sexa 'NY' ou 'NJ'.
```javascript
db.zips.find({
  $or: [
    { state: "NY" },
    { state: "NJ" }
  ]
})
```

6. (BD: sample_training) Selecciona cidades onde a poboación non sexa maior de 50.000.
```javascript
db.zips.find({
  pop: { $not: { $gt: 50000 } }
})
```

7. (BD: sample_training) Selecciona cidades que non estean en California nin teñan poboación inferior a 5000.
```javascript
db.zips.find({
  $nor: [
    { state: "CA" },
    { pop: { $lt: 5000 } }
  ]
})
```

### Operadores de comparación

8. (BD: sample_training) Selecciona cidades de Texas cunha poboación menor que 1000.
```javascript
db.zips.find({
  state: "TX",
  pop: { $lt: 1000 }
})
```

### Operadores de existencia e tipo

9. (BD: sample_training) Selecciona documentos de grades que teñan o campo score.
```javascript
db.grades.find({ score: { $exists: true } })
```

10. (BD: sample_training) Selecciona documentos onde student_id sexa un número.
```javascript
db.grades.find({ student_id: { $type: "int" } })
```

### Operadores para arrays

11. (BD: sample_mflix) Selecciona películas que teñan o xénero 'Drama'.
```javascript
use sample_mflix
db.movies.find({
  genres: { $in: ["Drama"] }
})
```

12. (BD: sample_mflix) Selecciona películas que teñan ao mesmo tempo 'Drama' e 'Romance'.
```javascript
db.movies.find({
  genres: { $all: ["Drama", "Romance"] }
})
```

13. (BD: sample_mflix) Selecciona películas cun reparto de 3 actores.
```javascript
db.movies.find({
  cast: { $size: 3 }
})
```

14. (BD: sample_training) Selecciona rexistros de grades onde algún exame teña unha nota maior ou igual que 80.
```javascript
db.grades.find({
  scores: {
    $elemMatch: {
      type: "exam",
      score: { $gte: 80 }
    }
  }
})
```

### Expresións regulares

15. (BD: sample_training) Selecciona cidades que comecen pola letra A.
```javascript
use sample_training
db.zips.find({ city: /^A/ })
```

16. (BD: sample_mflix) Selecciona películas onde o título conteña 'love' sen distinguir maiúsculas.
```javascript
use sample_mflix
db.movies.find({ title: /love/i })
```

### Proxección

17. (BD: sample_training) Mostrar só cidade e estado, sen _id.
```javascript
use sample_training
db.zips.find(
  { state: "FL" },
  { _id: 0, city: 1, state: 1 }
)
```

### Uso de $expr

18. (BD: sample_training) Selecciona documentos onde score sexa igual a student_id.
```javascript
db.grades.find({
  $expr: { $eq: ["$score", "$student_id"] }
})
```

19. (BD: sample_training) Selecciona documentos onde score + 10 > 90.
```javascript
use sample_training
db.grades.find({
  $expr: { $gt: [{ $add: ["$score", 10] }, 90] }
})
```

### Documentos anidados

20. (BD: sample_airbnb) Selecciona vivendas situadas en España.
```javascript
use sample_airbnb
db.listingsAndReviews.find({
  "address.country": "Spain"
})
```

### Ordenación e limitación

21. (BD: sample_training) Selecciona as 5 cidades máis poboadas de California.
```javascript
use sample_training
db.zips.find({ state: "CA" })
  .sort({ pop: -1 })
  .limit(5)
```

22. (BD: sample_mflix) Obter as 10 películas máis recentes.
```javascript
use sample_mflix
db.movies.find()
  .sort({ year: -1 })
  .limit(10)
```

### Distinct

23. (BD: sample_training) Obter todos os estados distintos da colección zips.
```javascript
use sample_training
db.zips.distinct("state")
```
